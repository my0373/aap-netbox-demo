- name: NetBox device webhook - read MAIN and print
  hosts: localhost
  gather_facts: false
  become: false

  tasks:
    # ------------------------------------------------------------
    # 1) Assert webhook injected device_data
    # ------------------------------------------------------------
    - name: Assert device_data is present
      ansible.builtin.assert:
        that:
          - device_data is defined
          - device_data.id is defined
        fail_msg: "Webhook payload did not inject device_data.id into the job"

    - name: Set device_id from webhook
      ansible.builtin.set_fact:
        device_id: "{{ device_data.id }}"

    # ------------------------------------------------------------
    # 2) Read NetBox connection info from environment (AAP credential)
    # ------------------------------------------------------------
    - name: Read NetBox connection from environment
      ansible.builtin.set_fact:
        netbox_url: "{{ lookup('env', 'NETBOX_URL') | default('', true) }}"
        netbox_token: "{{ lookup('env', 'NETBOX_TOKEN') | default('', true) }}"

    - name: Assert NetBox connection vars are present
      ansible.builtin.assert:
        that:
          - netbox
